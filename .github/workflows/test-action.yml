name: Test Action

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:
    inputs:
      image_repository:
        description: 'Docker image repository to test'
        required: false
      image_tag:
        description: 'Docker image tag to test (leave empty for pinned version)'
        required: false
      use_experimental_features:
        description: 'Use alternative image configuration'
        type: boolean
        default: false

jobs:
  test-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run action (dry-run mode)
        uses: ./
        if: github.event_name == 'pull_request'
        with:
          path: test/docs
          space: TEST
          api_key: dummy-key-for-testing
        continue-on-error: true

      - name: Run action (live test)
        uses: ./
        if: github.event_name == 'push' && vars.CONFLUENCE_SPACE_KEY != ''
        with:
          path: test/docs
          domain: ${{ vars.CONFLUENCE_DOMAIN }}
          username: ${{ vars.CONFLUENCE_USER_NAME }}
          api_key: ${{ secrets.CONFLUENCE_API_KEY }}
          space: ${{ vars.CONFLUENCE_SPACE_KEY }}
          root_page_id: ${{ vars.CONFLUENCE_ROOT_PAGE_ID }}
          # title_prefix: 'Action Test - '
          keep_hierarchy: true
          render_mermaid: true
          render_plantuml: true
          diagram_format: 'svg'

      - name: Run action (manual test)
        uses: ./
        if: github.event_name == 'workflow_dispatch'
        with:
          path: test/docs
          image_repository: ${{ github.event.inputs.image_repository }}
          image_tag: ${{ github.event.inputs.image_tag }}
          use_experimental_features: ${{ github.event.inputs.use_experimental_features }}
          domain: ${{ vars.CONFLUENCE_DOMAIN }}
          username: ${{ vars.CONFLUENCE_USER_NAME }}
          api_key: ${{ secrets.CONFLUENCE_API_KEY }}
          space: ${{ vars.CONFLUENCE_SPACE_KEY }}
          root_page_id: ${{ vars.CONFLUENCE_ROOT_PAGE_ID }}
          title_prefix: 'Manual Test - '
          keep_hierarchy: true
          render_mermaid: true
          render_plantuml: true
          diagram_format: 'svg'
