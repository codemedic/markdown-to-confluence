name: Test Action

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:
    inputs:
      image_repository:
        description: 'Docker image repository to test'
        required: false
      image_tag:
        description: 'Docker image tag to test (leave empty for pinned version)'
        required: false
      use_experimental_features:
        description: 'Use experimental features in the action (alternative docker image)'
        type: boolean
        default: false
      debug:
        description: 'Enable debug logging for the action'
        type: boolean
        default: false

jobs:
  setup:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && vars.CONFLUENCE_SPACE_KEY != ''
    outputs:
      root_page_id: ${{ steps.create_root.outputs.root_id }}
      space_id: ${{ steps.get_space.outputs.space_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get Space and Parent ID
        id: get_space
        env:
          DEBUG: ${{ inputs.debug == true && '1' || '0' }}
        run: |
          SPACE_ID=$(./scripts/confluence-utils.sh get-space-id "${{ vars.CONFLUENCE_DOMAIN }}" "${{ secrets.CONFLUENCE_API_KEY }}" "${{ vars.CONFLUENCE_SPACE_KEY }}" "${{ vars.CONFLUENCE_USER_NAME }}")
          echo "space_id=${SPACE_ID}" >> "$GITHUB_OUTPUT"
          
          # Use configured root_page_id if available, otherwise fallback to homepage
          if [[ -n "${{ vars.CONFLUENCE_ROOT_PAGE_ID }}" ]]; then
            echo "parent_id=${{ vars.CONFLUENCE_ROOT_PAGE_ID }}" >> "$GITHUB_OUTPUT"
          else
            HOMEPAGE_ID=$(./scripts/confluence-utils.sh get-homepage-id "${{ vars.CONFLUENCE_DOMAIN }}" "${{ secrets.CONFLUENCE_API_KEY }}" "${SPACE_ID}" "${{ vars.CONFLUENCE_USER_NAME }}")
            echo "parent_id=${HOMEPAGE_ID}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Test Run Root Page
        id: create_root
        env:
          DEBUG: ${{ inputs.debug == true && '1' || '0' }}
        run: |
          TITLE="Test Run - $(date +'%Y-%m-%d %H:%M:%S') - ${{ github.run_id }}"
          ROOT_ID=$(./scripts/confluence-utils.sh create-page \
            "${{ vars.CONFLUENCE_DOMAIN }}" \
            "${{ secrets.CONFLUENCE_API_KEY }}" \
            "${{ steps.get_space.outputs.space_id }}" \
            "${{ steps.get_space.outputs.parent_id }}" \
            "${TITLE}" \
            "<p>Integration test run for branch <code>${{ github.ref_name }}</code>. Run ID: <a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">${{ github.run_id }}</a></p>" \
            "${{ vars.CONFLUENCE_USER_NAME }}")
          echo "root_id=${ROOT_ID}" >> "$GITHUB_OUTPUT"


  test-action:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        keep_hierarchy: [true, false]
        diagram_format: [png, svg]
        alignment: [center, left, right]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set Combination Variables
        id: vars
        run: |
          NAME="H:${{ matrix.keep_hierarchy }}|D:${{ matrix.diagram_format }}|A:${{ matrix.alignment }}"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "title_prefix=[${NAME}] " >> "$GITHUB_OUTPUT"
          echo "generated_by=Generated with Hierarchy=${{ matrix.keep_hierarchy }}, Format=${{ matrix.diagram_format }}, Alignment=${{ matrix.alignment }}." >> "$GITHUB_OUTPUT"

      - name: Create Combination Root Page
        id: combo_root
        env:
          DEBUG: ${{ inputs.debug == true && '1' || '0' }}
        run: |
          TITLE="${{ steps.vars.outputs.name }} - ${{ github.run_id }}"
          COMBO_ID=$(./scripts/confluence-utils.sh create-page \
            "${{ vars.CONFLUENCE_DOMAIN }}" \
            "${{ secrets.CONFLUENCE_API_KEY }}" \
            "${{ needs.setup.outputs.space_id }}" \
            "${{ needs.setup.outputs.root_page_id }}" \
            "${TITLE}" \
            "<p>Test combination: <code>${{ steps.vars.outputs.name }}</code></p><ul>
              <li>Keep Hierarchy: <code>${{ matrix.keep_hierarchy }}</code></li>
              <li>Diagram Format: <code>${{ matrix.diagram_format }}</code></li>
              <li>Alignment: <code>${{ matrix.alignment }}</code></li>
              <li>Experimental: <code>${{ inputs.use_experimental_features || 'false' }}</code></li>
            </ul>" \
            "${{ vars.CONFLUENCE_USER_NAME }}")
          echo "combo_root_id=${COMBO_ID}" >> "$GITHUB_OUTPUT"

      - name: Run action
        uses: ./
        with:
          path: test/docs
          domain: ${{ vars.CONFLUENCE_DOMAIN }}
          username: ${{ vars.CONFLUENCE_USER_NAME }}
          api_key: ${{ secrets.CONFLUENCE_API_KEY }}
          space: ${{ vars.CONFLUENCE_SPACE_KEY }}
          root_page_id: ${{ steps.combo_root.outputs.combo_root_id }}
          keep_hierarchy: ${{ matrix.keep_hierarchy }}
          diagram_format: ${{ matrix.diagram_format }}
          title_prefix: ${{ steps.vars.outputs.title_prefix }}
          generated_by: ${{ steps.vars.outputs.generated_by }}
          alignment: ${{ matrix.alignment }}
          image_repository: ${{ github.event.inputs.image_repository }}
          image_tag: ${{ github.event.inputs.image_tag }}
          use_experimental_features: ${{ inputs.use_experimental_features || false }}
          debug: ${{ inputs.debug || false }}

  dry-run:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run action (dry-run mode)
        uses: ./
        with:
          path: test/docs
          space: TEST
          api_key: dummy-key-for-testing
        continue-on-error: true

